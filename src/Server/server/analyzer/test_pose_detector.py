"""
Тесты для детектора поз
"""
import unittest
import sys
import os

current_dir = os.path.dirname(os.path.abspath(__file__))
sys.path.insert(0, current_dir)

from pose_detector import PoseDetector
from pose_deviants import calculate_deviations
import skeleton_transformer as transformer

sys.path.insert(0, os.path.join(current_dir, "poses"))
from poses.pose_loader import load_poses

class TestPoseDetector(unittest.TestCase):
    
    def setUp(self):
        self.poses = load_poses("poses") 
        self.detector = PoseDetector(self.poses)
    
    def test_t_pose_detection(self):
        t_pose_points = [
            [0.43337857723236, -0.02168646268547, -0.39348560571671],
            [0.43709075450897, -0.03769075497985, -0.3840534389019],
            [0.44077613949776, -0.03436168283224, -0.38405746221542],
            [0.44389906525612, -0.03172951191664, -0.38416096568108],
            [0.42803660035133, -0.0409618653357, -0.38064357638359],
            [0.42495840787888, -0.03946433216333, -0.38071939349175],
            [0.42195001244545, -0.03859015926719, -0.38070115447044],
            [0.44642466306686, -0.01304059848189, -0.29873129725456],
            [0.41439610719681, -0.02344407513738, -0.28142973780632],
            [0.43847125768662, 0.00409419741482, -0.35943999886513],
            [0.42811897397041, 0.00309604033828, -0.35426178574562],
            [0.49800327420235, 0.08599424362183, -0.24885620176792],
            [0.36014112830162, 0.09127222001553, -0.20932406187058],
            [0.59696090221405, 0.10271226614714, -0.27472561597824],
            [0.25453436374664, 0.10926274955273, -0.20728506147861],
            [0.68551909923553, 0.09785138070583, -0.40386289358139],
            [0.15760482847691, 0.11122304946184, -0.319301456213],
            [0.7153622508049, 0.10746095329523, -0.43898570537567],
            [0.12769705057144, 0.10873142629862, -0.34710210561752],
            [0.71574836969376, 0.10226966440678, -0.48257037997246],
            [0.12694443762302, 0.10451979190111, -0.40123265981674],
            [0.70535349845886, 0.10054521262646, -0.43114763498306],
            [0.13621701300144, 0.10734093934298, -0.35097754001617],
            [0.46931639313698, 0.43738201260567, -0.02935077436268],
            [0.39914056658745, 0.44388511776924, 0.02933238819242],
            [0.46737039089203, 0.66578763723373, 0.02397361956537],
            [0.40546479821205, 0.67284321784973, 0.13465994596481],
            [0.46786463260651, 0.85898810625076, 0.31316855549812],
            [0.42879799008369, 0.845046043396, 0.41423776745796],
            [0.46780130267143, 0.88182872533798, 0.33366823196411],
            [0.43876460194588, 0.86571979522705, 0.43465083837509],
            [0.46770590543747, 0.93780070543289, 0.18101662397385],
            [0.41765579581261, 0.93193113803864, 0.30422449111939]
        ]
        
        current_pose = transformer.landmarks_to_pose(t_pose_points)
        detected_poses = self.detector.detect_pose(current_pose)
        
        self.assertGreater(len(detected_poses), 0)
        t_pose_found = any(pose.name == "t_pose" for pose in detected_poses)
        self.assertTrue(t_pose_found)
        
        deviations = calculate_deviations(current_pose, detected_poses)
        print("T-pose deviations:", deviations)
    
    def test_arms_down_pose_detection(self):
        arms_down_points = [
            [0.4446859061718, -0.04089827090502, -0.44245237112045],
            [0.44895234704018, -0.05287080258131, -0.42343011498451],
            [0.45286720991135, -0.04858280345798, -0.42341873049736],
            [0.45652481913567, -0.04467226937413, -0.42339262366295],
            [0.43799468874931, -0.05429099500179, -0.42543178796768],
            [0.43459764122963, -0.05047422274947, -0.42550572752953],
            [0.43027293682098, -0.04694251716137, -0.42560616135597],
            [0.45855671167374, -0.02398985438049, -0.29509773850441],
            [0.42317628860474, -0.0263491794467, -0.30551347136498],
            [0.45119950175285, -0.01137582678348, -0.39356061816216],
            [0.43920543789864, -0.01351650711149, -0.3967404961586],
            [0.50945430994034, 0.11091732978821, -0.20124647021294],
            [0.37641870975494, 0.12159193307161, -0.21547228097916],
            [0.52255845069885, 0.30523544549942, -0.11495853215456],
            [0.36885243654251, 0.317164093256, -0.15683460235596],
            [0.52618843317032, 0.46372359991074, -0.21735945343971],
            [0.36895373463631, 0.47633373737335, -0.24750179052353],
            [0.5292489528656, 0.51293474435806, -0.25318092107773],
            [0.36989036202431, 0.53001272678375, -0.28484842181206],
            [0.52042019367218, 0.51136338710785, -0.29271927475929],
            [0.37857621908188, 0.52475053071976, -0.32586166262627],
            [0.51675200462341, 0.49404391646385, -0.23399844765663],
            [0.38096863031387, 0.50578999519348, -0.26491197943687],
            [0.48194754123688, 0.44181826710701, 0.00101361738052],
            [0.41507160663605, 0.44614186882973, -0.00123540998902],
            [0.48315688967705, 0.68577617406845, 0.02980415895581],
            [0.41244888305664, 0.67263519763947, 0.03922303020954],
            [0.48580583930016, 0.88577944040299, 0.33803796768189],
            [0.43139961361885, 0.87547266483307, 0.32738128304482],
            [0.48183062672615, 0.90296614170075, 0.35970637202263],
            [0.43526276946068, 0.89633923768997, 0.34871357679367],
            [0.486258238554, 0.96423983573914, 0.21105517446995],
            [0.42765524983406, 0.96236550807953, 0.19612842798233]
        ]
        
        current_pose = transformer.landmarks_to_pose(arms_down_points)
        detected_poses = self.detector.detect_pose(current_pose)
        
        self.assertGreater(len(detected_poses), 0)
        arms_down_found = any(pose.name == "arms_down" for pose in detected_poses)
        self.assertTrue(arms_down_found)
        
        deviations = calculate_deviations(current_pose, detected_poses)
        print("Arms-down deviations:", deviations)
    
    def test_unknown_pose_no_detection(self):
        unknown_pose_points = [
            [0.43315500020981, -0.0152943963185, -0.2632532119751],
            [0.43837544322014, -0.0288357399404, -0.25472643971443],
            [0.44018724560738, -0.02777613699436, -0.25478649139404],
            [0.44174206256866, -0.02730458788574, -0.25488764047623],
            [0.43188095092773, -0.03020882792771, -0.24896182119846],
            [0.43000492453575, -0.02994019910693, -0.24898125231266],
            [0.425462692976, -0.03097759559751, -0.24906097352505],
            [0.44287496805191, -0.01171371527016, -0.17180027067661],
            [0.42263209819794, -0.01448221504688, -0.14335076510906],
            [0.4367758333683, 0.00794063229114, -0.22997109591961],
            [0.42992147803307, 0.0079760523513, -0.22199015319347],
            [0.49010851979256, 0.0824698060751, -0.12679269909859],
            [0.37098488211632, 0.08911731094122, -0.07078934460878],
            [0.58488857746124, 0.11992567777634, -0.11454445868731],
            [0.27745190262794, 0.14025191962719, -0.05331132933497],
            [0.60016947984695, 0.25467967987061, -0.19929271936417],
            [0.25376811623573, 0.27326548099518, -0.13382296264172],
            [0.60785180330276, 0.29535952210426, -0.22483088076115],
            [0.2478002011776, 0.3095595240593, -0.15743997693062],
            [0.5952211022377, 0.30095985531807, -0.25525739789009],
            [0.26456850767136, 0.31512799859047, -0.19594965875149],
            [0.59026581048965, 0.2884524166584, -0.21343928575516],
            [0.26832139492035, 0.3051677942276, -0.1530637294054],
            [0.47006577253342, 0.42289063334465, -0.02400427311659],
            [0.40914127230644, 0.42737093567848, 0.02383933775127],
            [0.47279506921768, 0.66256564855576, 0.0072748917155],
            [0.40681234002113, 0.66285884380341, 0.08179214596748],
            [0.47891816496849, 0.85358828306198, 0.28282409906387],
            [0.41997185349464, 0.84716606140137, 0.3296976685524],
            [0.47248408198357, 0.87171429395676, 0.30219614505768],
            [0.43049076199532, 0.87150430679321, 0.34742420911789],
            [0.48401069641113, 0.93488013744354, 0.15799953043461],
            [0.40908414125443, 0.9309133887291, 0.21493278443813]
        ]
        
        current_pose = transformer.landmarks_to_pose(unknown_pose_points)
        detected_poses = self.detector.detect_pose(current_pose)
        
        for pose in self.poses:
            if pose == current_pose:
                self.fail(f"Неизвестная поза ошибочно определена как {pose.name}")
        
        deviations = calculate_deviations(current_pose, detected_poses)
        print("Unknown pose deviations:", deviations)

if __name__ == '__main__':
    unittest.main()
