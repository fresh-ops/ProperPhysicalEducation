import math
from poses.pose import Pose

NUM_POINTS = 33  # Количество точек цифрового скелета
NUM_COORDINATES = 3  # Количество координатных осей для точки

CONNECTIONS = {
    # ГОЛОВА
    0: [2, 5],
    1: [2],
    2: [0, 1, 3, 7],
    3: [2],
    4: [5],
    5: [0, 4, 6, 8],
    6: [5],
    7: [2],
    8: [5],
    9: [10],
    10: [9],

    # ТЕЛО
    11: [12, 13, 23],
    12: [11, 14, 24],
    13: [11, 15],
    14: [12, 16],
    15: [13, 17, 19, 21],
    16: [14, 18, 20, 22],
    17: [15, 19],
    18: [16, 20],
    19: [15, 17],
    20: [16, 18],
    21: [15],
    22: [16],
    23: [11, 24, 25],
    24: [12, 23, 26],
    25: [23, 27],
    26: [24, 28],
    27: [25, 29, 31],
    28: [26, 30, 32],
    29: [27, 31],
    30: [28, 32],
    31: [27, 29],
    32: [28, 30]
}

# Тестовые данные точек скелета
TEST_POINTS = [[0.4446859061718, -0.04089827090502, -0.44245237112045],
               [0.44895234704018, -0.05287080258131, -0.42343011498451],
               [0.45286720991135, -0.04858280345798, -0.42341873049736],
               [0.45652481913567, -0.04467226937413, -0.42339262366295],
               [0.43799468874931, -0.05429099500179, -0.42543178796768],
               [0.43459764122963, -0.05047422274947, -0.42550572752953],
               [0.43027293682098, -0.04694251716137, -0.42560616135597],
               [0.45855671167374, -0.02398985438049, -0.29509773850441],
               [0.42317628860474, -0.0263491794467, -0.30551347136498],
               [0.45119950175285, -0.01137582678348, -0.39356061816216],
               [0.43920543789864, -0.01351650711149, -0.3967404961586],
               [0.50945430994034, 0.11091732978821, -0.20124647021294],
               [0.37641870975494, 0.12159193307161, -0.21547228097916],
               [0.52255845069885, 0.30523544549942, -0.11495853215456],
               [0.36885243654251, 0.317164093256, -0.15683460235596],
               [0.52618843317032, 0.46372359991074, -0.21735945343971],
               [0.36895373463631, 0.47633373737335, -0.24750179052353],
               [0.5292489528656, 0.51293474435806, -0.25318092107773],
               [0.36989036202431, 0.53001272678375, -0.28484842181206],
               [0.52042019367218, 0.51136338710785, -0.29271927475929],
               [0.37857621908188, 0.52475053071976, -0.32586166262627],
               [0.51675200462341, 0.49404391646385, -0.23399844765663],
               [0.38096863031387, 0.50578999519348, -0.26491197943687],
               [0.48194754123688, 0.44181826710701, 0.00101361738052],
               [0.41507160663605, 0.44614186882973, -0.00123540998902],
               [0.48315688967705, 0.68577617406845, 0.02980415895581],
               [0.41244888305664, 0.67263519763947, 0.03922303020954],
               [0.48580583930016, 0.88577944040299, 0.33803796768189],
               [0.43139961361885, 0.87547266483307, 0.32738128304482],
               [0.48183062672615, 0.90296614170075, 0.35970637202263],
               [0.43526276946068, 0.89633923768997, 0.34871357679367],
               [0.486258238554, 0.96423983573914, 0.21105517446995],
               [0.42765524983406, 0.96236550807953, 0.19612842798233]]


class AngleAnalyzer:
    def __init__(self):
        self.points = [(0.0, 0.0, 0.0)] * NUM_POINTS
        self.angles = {}
        self.angle_history = {}

                
    def calculate_angle(self, p1_idx, p2_idx, p3_idx):
        """
        Вычисляет угол в точке p2 между линиями p1-p2 и p3-p2
        В ПЛОСКОСТИ XY (плоская проекция, Z игнорируется)

        Args:
            p1_idx: индекс первой точки
            p2_idx: индекс центральной точки (вершина угла)
            p3_idx: индекс третьей точки

        Returns:
            float: угол в градусах (0-180)
        """
        p1 = self.points[p1_idx]
        p2 = self.points[p2_idx]
        p3 = self.points[p3_idx]

        v1 = (p1[0] - p2[0], p1[1] - p2[1])
        v2 = (p3[0] - p2[0], p3[1] - p2[1])


        v1_len = math.sqrt(v1[0]**2 + v1[1]**2)
        v2_len = math.sqrt(v2[0]**2 + v2[1]**2)
        
        if v1_len < 1e-6 or v2_len < 1e-6:

            return 0.0

        angle1 = math.atan2(v1[1], v1[0])
        angle2 = math.atan2(v2[1], v2[0])

        angle_diff = abs(angle1 - angle2)

        if angle_diff > math.pi:
            angle_diff = 2 * math.pi - angle_diff

        return math.degrees(angle_diff)

    def calculate_all_angles(self):
        """
        Вычисляет все углы между связанными точками скелета согласно конфигурации CONNECTIONS

        Returns:
            dict: словарь со всеми вычисленными углами, где ключ - кортеж (центральная_точка, точка1, точка2),
                  значение - словарь с данными угла (angle, points, center)
        """
        angles = {}

        for center_idx, connections in CONNECTIONS.items():
            if len(connections) >= 2:
                for i in range(len(connections)):
                    for j in range(i + 1, len(connections)):
                        p1_idx = connections[i]
                        p3_idx = connections[j]

                        key = (center_idx, p1_idx, p3_idx)

                        angle = self.calculate_angle(p1_idx, center_idx, p3_idx)

                        angles[key] = {
                            'angle': angle,
                            'points': (p1_idx, center_idx, p3_idx),
                            'center': center_idx
                        }

                        if key not in self.angle_history:
                            self.angle_history[key] = []
                        self.angle_history[key].append(angle)

                        if len(self.angle_history[key]) > 100:
                            self.angle_history[key] = self.angle_history[key][-100:]

        self.angles = angles
        return angles

    def get_current_pose(self) -> Pose:
        """
        Создает объект Pose с текущими вычисленными углами тела

        Вычисляет ключевые углы для определения позы:
        - Углы плеч (между рукой и туловищем)
        - Углы локтей (в локтевых суставах)
        - Углы коленей (в коленных суставах)

        Returns:
            Pose: объект позы с вычисленными углами, пустым именем и нулевым порогом
        """
        return Pose(
            name="",
            threshold=0.0,
            left_shoulder_angle=self.calculate_angle(13, 11, 23),
            right_shoulder_angle=self.calculate_angle(14, 12, 24),
            left_elbow_angle=self.calculate_angle(11, 13, 15),
            right_elbow_angle=self.calculate_angle(12, 14, 16),
            left_knee_angle=self.calculate_angle(23, 25, 27),
            right_knee_angle=self.calculate_angle(24, 26, 28)
        )